# File Upload Flow Documentation

This document describes the file upload flow for the Surakshit AI Security Vulnerability Dashboard, allowing users to upload their codebase as a zip file for vulnerability scanning.

## Overview

The file upload feature enables users to:
- Upload their codebase as a zip file
- Validate the zip file structure
- Extract the codebase for scanning
- Initiate a vulnerability scan on the extracted code
- View the scan results

## File Upload Flow Diagram

```mermaid
flowchart TD
    A[User Selects Zip File] --> B[Frontend Validates File Type]
    B --> C{Valid Zip?}
    C -->|No| D[Display Error Message]
    D --> A
    C -->|Yes| E[Show Upload Button]
    E --> F[User Clicks Upload & Scan]
    F --> G[Upload Progress Indicator]
    G --> H[Send File to Backend]
    H --> I[Backend Receives File]
    I --> J[Validate Zip Structure]
    J --> K{Valid Structure?}
    K -->|No| L[Return Error to Frontend]
    L --> M[Display Error to User]
    K -->|Yes| N[Extract Zip Contents]
    N --> O[Initiate Vulnerability Scan]
    O --> P[Return Scan ID to Frontend]
    P --> Q[Redirect to Scan Results Tab]
    Q --> R[Display Scan Progress/Results]
```

## Component Interaction

```mermaid
sequenceDiagram
    participant User
    participant FileUpload
    participant Dashboard
    participant Backend
    participant FileSystem
    participant ScanService
    
    User->>FileUpload: Select zip file
    FileUpload->>FileUpload: Validate file type
    
    alt Invalid File Type
        FileUpload->>User: Display error message
    else Valid File Type
        FileUpload->>User: Show upload button
        User->>FileUpload: Click Upload & Scan
        FileUpload->>FileUpload: Show progress indicator
        FileUpload->>Backend: POST /api/upload (multipart/form-data)
        Backend->>FileSystem: Save zip file
        Backend->>FileSystem: Create extraction directory
        Backend->>FileSystem: Extract zip contents
        Backend->>FileSystem: Validate extracted content
        
        alt Extraction Failed
            Backend->>FileSystem: Clean up files
            Backend->>FileUpload: Return error response
            FileUpload->>User: Display error message
        else Extraction Successful
            Backend->>ScanService: Initiate scan on extracted code
            ScanService->>Backend: Return scan ID
            Backend->>FileUpload: Return success with scan ID
            FileUpload->>Dashboard: Notify upload complete
            Dashboard->>User: Switch to Scan Results tab
            Dashboard->>User: Display scan progress/results
        end
    end
```

## Backend Processing Flow

```mermaid
flowchart TD
    A[Receive Upload Request] --> B[Validate Request]
    B --> C{File Present?}
    C -->|No| D[Return 400 Error]
    C -->|Yes| E[Save File to Disk]
    E --> F[Create Extraction Directory]
    F --> G[Extract Zip File]
    G --> H{Extraction Successful?}
    H -->|No| I[Clean Up Files]
    I --> J[Return Error Response]
    H -->|Yes| K[Validate Extracted Content]
    K --> L{Content Valid?}
    L -->|No| I
    L -->|Yes| M[Initiate Vulnerability Scan]
    M --> N[Return Success Response with Scan ID]
```

## Error Handling

The file upload flow includes comprehensive error handling:

1. **Frontend Validation:**
   - Validates file type (must be .zip)
   - Checks file size (maximum 50MB)
   - Provides immediate feedback to the user

2. **Backend Validation:**
   - Verifies the file is a valid zip archive
   - Ensures the zip can be extracted properly
   - Validates the extracted content contains actual code files
   - Handles filesystem errors gracefully

3. **Error Responses:**
   - Clear error messages are returned to the frontend
   - User-friendly error messages are displayed
   - Temporary files are cleaned up on error

## Security Considerations

The file upload implementation includes several security measures:

1. **File Type Validation:**
   - Both frontend and backend validate the file is a zip
   - MIME type and file extension checks

2. **Size Limitations:**
   - Maximum file size enforced (50MB)
   - Prevents denial of service attacks

3. **Secure Storage:**
   - Files stored in a dedicated upload directory
   - Unique filenames generated using UUID
   - Extraction in isolated directories

4. **Content Validation:**
   - Extracted content is validated before processing
   - Malformed zip files are rejected

5. **Resource Cleanup:**
   - Temporary files are removed after processing
   - Failed uploads are cleaned up automatically